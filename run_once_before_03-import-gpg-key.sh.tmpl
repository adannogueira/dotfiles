#!/bin/bash
set -e

echo "Setting up GPG..."

# Set correct permissions for GPG directory
mkdir -p ~/.gnupg
chown -R $(whoami) ~/.gnupg/
find ~/.gnupg -type f -exec chmod 600 {} \;
find ~/.gnupg -type d -exec chmod 700 {} \;

# Check if key already exists
if gpg --list-secret-keys D9DE481B8DEFABC9 &>/dev/null; then
    echo "✓ GPG key already imported"
    exit 0
fi

echo "Importing GPG key from Bitwarden..."

# Get GPG key and passphrase from Bitwarden
GPG_KEY="{{ (bitwarden "item" "gpg-private-key").notes }}"
GPG_PASS="{{ (bitwardenFields "item" "gpg-private-key").passphrase.value }}"

if [ -z "$GPG_KEY" ]; then
    echo "ERROR: Failed to retrieve GPG key from Bitwarden"
    exit 1
fi

# Import key non-interactively
if echo "$GPG_KEY" | base64 -d | gpg --batch --yes --passphrase "$GPG_PASS" --import 2>&1; then
    echo "✓ GPG key imported successfully"
else
    echo "ERROR: Failed to import GPG key"
    exit 1
fi

# Set ultimate trust for the key
KEY_FINGERPRINT=$(gpg --list-secret-keys --with-colons | grep fpr | head -n1 | cut -d':' -f10)
if [ -n "$KEY_FINGERPRINT" ]; then
    echo "$KEY_FINGERPRINT:6:" | gpg --import-ownertrust
    echo "✓ Set trust level for key: $KEY_FINGERPRINT"
fi

# Restart gpg-agent to pick up changes
gpgconf --kill gpg-agent 2>/dev/null || true

echo "✓ GPG setup complete"
