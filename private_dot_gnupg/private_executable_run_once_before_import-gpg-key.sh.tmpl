#!/bin/bash
set -e

echo "Importing GPG key..."

# Get GPG key and passphrase from Bitwarden
GPG_KEY="{{ (bitwarden "item" "gpg-private-key").notes }}"
GPG_PASS="{{ (bitwardenFields "item" "gpg-private-key").passphrase.value }}"

# Import key non-interactively
echo "$GPG_KEY" | base64 -d | gpg --batch --passphrase "$GPG_PASS" --import

# Set ultimate trust for the key (optional)
KEY_ID=$(gpg --list-secret-keys --keyid-format=long | grep sec | awk '{print $2}' | cut -d'/' -f2 | head -n1)
if [ -n "$KEY_ID" ]; then
    echo "$KEY_ID:6:" | gpg --import-ownertrust
fi

echo "GPG key imported successfully"
