#!/bin/bash
set -e

# Install Bitwarden CLI if not present
if ! command -v bw &> /dev/null; then
    echo "Installing Bitwarden CLI..."
    curl -L "https://vault.bitwarden.com/download/?app=cli&platform=linux" -o /tmp/bw.zip
    unzip -q /tmp/bw.zip -d /tmp
    chmod +x /tmp/bw
    sudo mv /tmp/bw /usr/local/bin/
    rm /tmp/bw.zip
    echo "Bitwarden CLI installed"
fi

# Check if BW_SESSION is set
if [ -z "$BW_SESSION" ]; then
    echo ""
    echo "=========================================="
    echo "ERROR: BW_SESSION environment variable is not set!"
    echo "=========================================="
    echo ""
    echo "Please run these commands first:"
    echo ""
    echo "1. Login to Bitwarden (with 2FA if enabled):"
    echo "   bw login"
    echo ""
    echo "2. Unlock and export session:"
    echo "   export BW_SESSION=\"\$(bw unlock --raw)\""
    echo ""
    echo "3. Then run chezmoi again:"
    echo "   chezmoi apply"
    echo ""
    exit 1
fi

# Verify session is valid
if ! bw unlock --check &> /dev/null; then
    echo ""
    echo "ERROR: BW_SESSION is invalid or expired!"
    echo "Please unlock again:"
    echo "  export BW_SESSION=\"\$(bw unlock --raw)\""
    echo ""
    exit 1
fi

echo "âœ“ Bitwarden session is valid"
